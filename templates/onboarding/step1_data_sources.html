{% extends "onboarding/base_step.html" %}

{% block title %}SocialMe - Content Sources{% endblock %}

{% block step_styles %}
<style>
.source-list {
  list-style-type: none;
  padding: 0;
}

.source-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #2a2a2a;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 5px;
  border: 1px solid var(--border-color);
}

.source-item button {
  background-color: transparent;
  color: #f44336;
  border: none;
  cursor: pointer;
}

.source-url {
  flex-grow: 1;
  margin-right: 10px;
  word-break: break-all;
}

.modal-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background-color: rgba(0, 0, 0, 0.8) !important;
  display: none;
  justify-content: center !important;
  align-items: center !important;
  z-index: 9999 !important;
}

.modal {
  background-color: var(--card-background) !important;
  padding: 30px !important;
  border-radius: 10px !important;
  width: 500px !important;
  max-width: 90% !important;
  border: 1px solid var(--border-color) !important;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
  position: relative !important;
  z-index: 10000 !important;
  transform: translateZ(0) !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.modal h2 {
  margin-top: 0;
  color: var(--accent-color);
  margin-bottom: 20px;
}

.modal p {
  margin-bottom: 20px;
  color: var(--text-color);
}

.modal input[type="url"] {
  width: 100%;
  padding: 12px;
  background-color: #333;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-color);
  font-size: 16px;
  margin-bottom: 20px;
}

.modal input[type="url"]:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(196, 164, 132, 0.2);
}

.modal-actions {
  display: flex;
  justify-content: space-between;
  gap: 15px;
}

.modal-actions button {
  flex: 1;
  padding: 12px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: background-color 0.3s;
}

.modal-actions button:first-child {
  background-color: var(--accent-color);
  color: white;
}

.modal-actions button:first-child:hover {
  background-color: #a68b72;
}

.modal-actions button:last-child {
  background-color: var(--button-background);
  color: var(--text-color);
}

.modal-actions button:last-child:hover {
  background-color: var(--button-hover);
}

.source-count {
  margin-top: 10px;
  color: var(--text-color);
  font-size: 0.9rem;
}

.preview-button {
  margin-left: 10px;
  background-color: var(--info-color);
  color: white;
  border: none;
  border-radius: 3px;
  padding: 3px 8px;
  cursor: pointer;
}

.preview-container {
  margin-top: 20px;
  background-color: #2a2a2a;
  padding: 15px;
  border-radius: 5px;
  border: 1px solid var(--border-color);
  display: none;
}

.preview-title {
  font-weight: bold;
  margin-bottom: 10px;
  color: var(--accent-color);
}

.source-instructions {
  margin-bottom: 20px;
  line-height: 1.6;
}

.source-types {
    background-color: var(--card-background);
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.source-types li {
    margin-bottom: 10px;
    color: var(--text-color);
}

.source-types strong {
    color: var(--accent-color);
}

.step-indicator {
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.info-box {
    background-color: var(--card-background);
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.info-box p {
    margin-bottom: 10px;
}

.source-counter {
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.add-source-button {
    background-color: var(--info-color);
    color: white;
    border: none;
    border-radius: 3px;
    padding: 8px 16px;
    cursor: pointer;
    margin-bottom: 20px;
}

.add-source-button:hover {
    background-color: var(--info-color-hover);
}

.nav-button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 3px;
    padding: 8px 16px;
    cursor: pointer;
}

.nav-button:hover {
    background-color: var(--primary-color-hover);
}

.nav-button:disabled {
    background-color: var(--primary-color-disabled);
    cursor: not-allowed;
}

.content-analysis {
    margin-top: 20px;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid var(--border-color);
}

.content-summary {
    background-color: var(--card-background);
    padding: 15px;
    border-radius: 5px;
}

.analysis-result {
    margin-top: 10px;
}

.error {
    background-color: var(--error-color);
    color: white;
}

.button-row {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    gap: 15px;
}

.button-row button {
    flex: 1;
}
</style>
{% endblock %}

{% block step_content %}
<div class="container">
    <div class="step-indicator">Step 1 of 4</div>
    
    <h1>Content Sources</h1>
    
    <div class="info-box">
        <p>Add links to content sources that represent your brand's voice and topics. These will be analyzed to generate content that matches your style.</p>
        
        <ul class="source-types">
            <li><strong>LinkedIn profiles</strong> - Professional content from your team</li>
            <li><strong>Twitter/X accounts</strong> - Social media tone and messaging</li>
            <li><strong>Blog articles</strong> - In-depth writing style and topics</li>
            <li><strong>RSS feeds</strong> - Regular content publications</li>
            <li><strong>News sources</strong> - Industry publications you follow</li>
            <li><strong>Newsletters</strong> - Email content you admire</li>
        </ul>
    </div>

    <div class="source-counter">
        Your Content Sources <span id="sourceCount">0</span>/50
        <div style="font-size: 0.8em; color: #666;">minimum 3, maximum 50</div>
    </div>

    <button class="add-source-button" onclick="showAddSourceModal()">Add Source (3 more required)</button>

    <div id="sourceList" class="source-list">
        <!-- Source items will be added here dynamically -->
    </div>

    <div class="content-analysis" id="contentAnalysis">
        <!-- Content analysis will be added here dynamically -->
    </div>

    <div class="button-row">
        <button class="nav-button" onclick="previousStep()" disabled>Back</button>
        <button class="nav-button" onclick="nextStep()" disabled>Next</button>
    </div>
</div>

<!-- Add Source Modal -->
<div id="addSourceModal" class="modal-overlay">
    <div class="modal">
        <h2>Add Content Source</h2>
        <p>Enter a URL to any content that represents your brand's voice and style.</p>
        
        <input type="url" id="sourceUrl" placeholder="https://..." />
        <div class="modal-actions">
            <button onclick="addSource()">Add Source</button>
            <button onclick="closeAddSourceModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block step_scripts %}
<script>
const sources = [];
const minSources = 3;
const maxSources = 50;

function updateSourceCount() {
    const sourceCount = sources.length;
    const sourceCountDisplay = document.getElementById('sourceCount');
    const addSourceButton = document.querySelector('.add-source-button');
    const nextButton = document.querySelector('.nav-button:last-child');
    
    sourceCountDisplay.textContent = sourceCount;
    
    if (sourceCount < minSources) {
        addSourceButton.textContent = `Add Source (${minSources - sourceCount} more required)`;
        nextButton.disabled = true;
    } else {
        addSourceButton.textContent = 'Add Source';
        nextButton.disabled = false;
    }
}

function showAddSourceModal() {
    const modal = document.getElementById('addSourceModal');
    const modalContent = modal.querySelector('.modal');
    
    modal.style.display = 'flex';
    modalContent.style.display = 'block';
    
    // Force modal to be visible
    modalContent.style.visibility = 'visible';
    modalContent.style.opacity = '1';
    
    document.getElementById('sourceUrl').focus();
}

function closeAddSourceModal() {
    const modal = document.getElementById('addSourceModal');
    modal.style.display = 'none';
    document.getElementById('sourceUrl').value = '';
}

function addSource() {
    const sourceUrl = document.getElementById('sourceUrl').value.trim();
    
    if (!sourceUrl) {
        alert('Please enter a valid URL');
        return;
    }
    
    // Add http:// if not present
    let formattedUrl = sourceUrl;
    if (!sourceUrl.startsWith('http://') && !sourceUrl.startsWith('https://')) {
        formattedUrl = 'https://' + sourceUrl;
    }
    
    // Check for duplicate
    if (sources.includes(formattedUrl)) {
        alert('This source has already been added');
        return;
    }
    
    // Add to sources array
    sources.push(formattedUrl);
    
    // Update UI
    updateSourceList();
    updateSourceCount();
    
    // Analyze content
    analyzeContent(formattedUrl);
    
    // Clear input and close modal
    document.getElementById('sourceUrl').value = '';
    closeAddSourceModal();
}

function removeSource(index) {
    sources.splice(index, 1);
    updateSourceList();
    updateSourceCount();
}

function updateSourceList() {
    const sourceList = document.getElementById('sourceList');
    sourceList.innerHTML = sources.map((source, index) => `
        <div class="source-item">
            <span class="source-url">${source}</span>
            <button onclick="removeSource(${index})" class="remove-source">Remove</button>
            <button onclick="analyzeContent('${source}')" class="preview-source">Preview</button>
        </div>
    `).join('');
}

function analyzeContent(url) {
    const analysisContainer = document.getElementById('contentAnalysis');
    analysisContainer.innerHTML = `
        <div class="content-summary">
            <h3>Content Analysis</h3>
            <p>Analyzing content from: ${url}</p>
            <div class="analysis-result">
                <p>Fetching content analysis...</p>
            </div>
        </div>
    `;

    // Call the correct analyze-content endpoint
    const formData = new FormData();
    formData.append('type', 'url');
    formData.append('content', url);

    console.log('Sending analysis request for:', url);
    console.log('Form data:', formData);

    fetch('/analyze-content', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Analysis response data:', data);
        
        if (data.status === 'error') {
            throw new Error(data.message);
        }
        
        analysisContainer.innerHTML = `
            <div class="content-summary">
                <h3>Content Analysis</h3>
                <p>Analysis for: ${url}</p>
                <div class="analysis-result">
                    <p><strong>Tone:</strong> ${data.tone || data.overall_tone || 'Professional'}</p>
                    <p><strong>Key Topics:</strong> ${data.topics ? data.topics.join(', ') : 'Technology, Business'}</p>
                    <p><strong>Complexity:</strong> ${data.complexity || 'Intermediate'}</p>
                    <p><strong>Writing Style:</strong> ${data.writing_style || 'Professional'}</p>
                </div>
            </div>
        `;
    })
    .catch(error => {
        console.error('Analysis error:', error);
        analysisContainer.innerHTML = `
            <div class="content-summary error">
                <h3>Content Analysis Error</h3>
                <p>Unable to analyze source: ${url}</p>
                <div class="analysis-result">
                    <p>Error: ${error.message}</p>
                    <p>Check the browser console for more details.</p>
                </div>
            </div>
        `;
    });
}

function nextStep() {
    if (sources.length >= minSources) {
        console.log('Submitting sources:', sources);
        
        fetch('/onboarding/step1', {
            method: 'POST',
            body: JSON.stringify({ sources: sources }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                console.log('Sources saved successfully, redirecting to step 2');
                window.location.href = '/onboarding/step2';
            } else {
                alert('Error saving sources: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    } else {
        alert(`Please add at least ${minSources} sources before continuing.`);
    }
}

function previousStep() {
    window.location.href = '/';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateSourceCount();
    
    // Close modal when clicking outside
    document.getElementById('addSourceModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddSourceModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAddSourceModal();
        }
    });
});
</script>
{% endblock %}

{% block navigation_buttons %}
<button class="nav-button" onclick="previousStep()" disabled>Back</button>
<button class="nav-button" onclick="nextStep()" disabled>Next</button>
{% endblock %}
