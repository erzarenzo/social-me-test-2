{% extends "onboarding/base_step.html" %}

{% block title %}SocialMe - Content Sources{% endblock %}

{% block step_styles %}
<style>
.source-list {
  list-style-type: none;
  padding: 0;
}

.source-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #2a2a2a;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 5px;
  border: 1px solid var(--border-color);
}

.source-item button {
  background-color: transparent;
  color: #f44336;
  border: none;
  cursor: pointer;
}

.source-url {
  flex-grow: 1;
  margin-right: 10px;
  word-break: break-all;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal {
  background-color: var(--card-background);
  padding: 30px;
  border-radius: 10px;
  width: 500px;
  max-width: 90%;
}

.modal h3 {
  margin-top: 0;
  color: var(--accent-color);
}

.modal-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

.source-count {
  margin-top: 10px;
  color: var(--text-color);
  font-size: 0.9rem;
}

.preview-button {
  margin-left: 10px;
  background-color: var(--info-color);
  color: white;
  border: none;
  border-radius: 3px;
  padding: 3px 8px;
  cursor: pointer;
}

.preview-container {
  margin-top: 20px;
  background-color: #2a2a2a;
  padding: 15px;
  border-radius: 5px;
  border: 1px solid var(--border-color);
  display: none;
}

.preview-title {
  font-weight: bold;
  margin-bottom: 10px;
  color: var(--accent-color);
}

.source-instructions {
  margin-bottom: 20px;
  line-height: 1.6;
}

.source-types {
    background-color: var(--card-background);
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.source-types li {
    margin-bottom: 10px;
    color: var(--text-color);
}

.source-types strong {
    color: var(--accent-color);
}

.step-indicator {
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.info-box {
    background-color: var(--card-background);
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.info-box p {
    margin-bottom: 10px;
}

.source-counter {
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.add-source-button {
    background-color: var(--info-color);
    color: white;
    border: none;
    border-radius: 3px;
    padding: 8px 16px;
    cursor: pointer;
}

.add-source-button:hover {
    background-color: var(--info-color-hover);
}

.nav-button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 3px;
    padding: 8px 16px;
    cursor: pointer;
}

.nav-button:hover {
    background-color: var(--primary-color-hover);
}

.nav-button:disabled {
    background-color: var(--primary-color-disabled);
    cursor: not-allowed;
}

.content-analysis {
    margin-top: 20px;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid var(--border-color);
}

.content-summary {
    background-color: var(--card-background);
    padding: 15px;
    border-radius: 5px;
}

.analysis-result {
    margin-top: 10px;
}

.error {
    background-color: var(--error-color);
    color: white;
}
</style>
{% endblock %}

{% block step_content %}
<div class="container">
    <div class="step-indicator">Step 1 of 4</div>
    
    <h1>Content Sources</h1>
    
    <div class="info-box">
        <p>Add links to content sources that represent your brand's voice and topics. These will be analyzed to generate content that matches your style.</p>
        
        <ul class="source-types">
            <li><strong>LinkedIn profiles</strong> - Professional content from your team</li>
            <li><strong>Twitter/X accounts</strong> - Social media tone and messaging</li>
            <li><strong>Blog articles</strong> - In-depth writing style and topics</li>
            <li><strong>RSS feeds</strong> - Regular content publications</li>
            <li><strong>News sources</strong> - Industry publications you follow</li>
            <li><strong>Newsletters</strong> - Email content you admire</li>
        </ul>
    </div>

    <div class="source-counter">
        Your Content Sources <span id="sourceCount">0</span>/50
        <div style="font-size: 0.8em; color: #666;">minimum 3, maximum 50</div>
    </div>

    <button class="add-source-button" onclick="showAddSourceModal()">Add Source (3 more required)</button>

    <div id="sourceList" class="source-list">
        <!-- Source items will be added here dynamically -->
    </div>

    <div class="content-analysis" id="contentAnalysis">
        <!-- Content analysis will be added here dynamically -->
    </div>

    <div class="button-row">
        <button class="nav-button" onclick="previousStep()" disabled>Back</button>
        <button class="nav-button" onclick="nextStep()" disabled>Next</button>
    </div>
</div>

<!-- Add Source Modal -->
<div id="addSourceModal" class="modal-overlay">
    <div class="modal">
        <h2>Add Content Source</h2>
        <p>Enter a URL to any content that represents your brand's voice and style.</p>
        
        <input type="url" id="sourceUrl" placeholder="https://..." />
        <div class="modal-actions">
            <button onclick="addSource()">Add Source</button>
            <button onclick="closeAddSourceModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block step_scripts %}
<script>
const sources = [];
const minSources = 3;
const maxSources = 50;

function updateSourceCount() {
    const sourceCount = sources.length;
    const sourceCountDisplay = document.getElementById('sourceCount');
    const addSourceButton = document.querySelector('.add-source-button');
    const nextButton = document.querySelector('.nav-button:last-child');
    
    sourceCountDisplay.textContent = sourceCount;
    
    if (sourceCount < minSources) {
        addSourceButton.textContent = `Add Source (${minSources - sourceCount} more required)`;
        nextButton.disabled = true;
    } else {
        addSourceButton.textContent = 'Add Source';
        nextButton.disabled = false;
    }
}

function showAddSourceModal() {
    document.getElementById('addSourceModal').style.display = 'block';
}

function closeAddSourceModal() {
    document.getElementById('addSourceModal').style.display = 'none';
    document.getElementById('sourceUrl').value = '';
}

function addSource() {
    const sourceUrl = document.getElementById('sourceUrl').value.trim();
    
    if (!sourceUrl) {
        alert('Please enter a valid URL');
        return;
    }
    
    // Add http:// if not present
    let formattedUrl = sourceUrl;
    if (!sourceUrl.startsWith('http://') && !sourceUrl.startsWith('https://')) {
        formattedUrl = 'https://' + sourceUrl;
    }
    
    // Check for duplicate
    if (sources.includes(formattedUrl)) {
        alert('This source has already been added');
        return;
    }
    
    // Add to sources array
    sources.push(formattedUrl);
    
    // Update UI
    updateSourceList();
    updateSourceCount();
    
    // Analyze content
    analyzeContent(formattedUrl);
    
    // Clear input and close modal
    document.getElementById('sourceUrl').value = '';
    closeAddSourceModal();
}

function removeSource(index) {
    sources.splice(index, 1);
    updateSourceList();
    updateSourceCount();
}

function updateSourceList() {
    const sourceList = document.getElementById('sourceList');
    sourceList.innerHTML = sources.map((source, index) => `
        <div class="source-item">
            <span class="source-url">${source}</span>
            <button onclick="removeSource(${index})" class="remove-source">Remove</button>
            <button onclick="analyzeContent('${source}')" class="preview-source">Preview</button>
        </div>
    `).join('');
}

function analyzeContent(url) {
    const analysisContainer = document.getElementById('contentAnalysis');
    analysisContainer.innerHTML = `
        <div class="content-summary">
            <h3>Content Analysis</h3>
            <p>Analyzing content from: ${url}</p>
            <div class="analysis-result">
                <p>Fetching content analysis...</p>
            </div>
        </div>
    `;

    // Simulate content analysis (replace with actual backend call)
    fetch('/analyze-source', {
        method: 'POST',
        body: JSON.stringify({ url: url }),
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        analysisContainer.innerHTML = `
            <div class="content-summary">
                <h3>Content Analysis</h3>
                <p>Analysis for: ${url}</p>
                <div class="analysis-result">
                    <p><strong>Tone:</strong> ${data.tone || 'Professional'}</p>
                    <p><strong>Key Topics:</strong> ${data.topics ? data.topics.join(', ') : 'Technology, Business'}</p>
                    <p><strong>Complexity:</strong> ${data.complexity || 'Intermediate'}</p>
                </div>
            </div>
        `;
    })
    .catch(error => {
        analysisContainer.innerHTML = `
            <div class="content-summary error">
                <h3>Content Analysis Error</h3>
                <p>Unable to analyze source: ${url}</p>
                <div class="analysis-result">
                    <p>Error: ${error.message}</p>
                </div>
            </div>
        `;
    });
}

function nextStep() {
    if (sources.length >= minSources) {
        fetch('/onboarding/step1', {
            method: 'POST',
            body: JSON.stringify({ sources: sources }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/onboarding/step2';
            } else {
                alert('Error saving sources. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    } else {
        alert(`Please add at least ${minSources} sources before continuing.`);
    }
}

function previousStep() {
    window.location.href = '/';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateSourceCount();
});
</script>
{% endblock %}

{% block navigation_buttons %}
<button class="nav-button" onclick="previousStep()" disabled>Back</button>
<button class="nav-button" onclick="nextStep()" disabled>Next</button>
{% endblock %}
